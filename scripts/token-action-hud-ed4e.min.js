const t={ID:"token-action-hud-ed4e"},e={ID:"token-action-hud-core"},a="1.4",i={talent:"earthdawn.t.talent",skill:"earthdawn.s.skill",spell:"earthdawn.s.spell",matrix:"tokenActionHud.ed4e.groupTitles.matrix",item:"tokenActionHud.ed4e.item",utility:"tokenActionHud.ed4e.utility",weaponAttack:"earthdawn.a.attack",power:"earthdawn.p.power"},s=["elementalist","illusionist","nethermancer","shaman","wizard"],n=["dexterity","strength","toughness","perception","willpower","charisma"],o={dexterity:"earthdawn.d.dexterity",strength:"earthdawn.s.strength",toughness:"earthdawn.t.toughness",perception:"earthdawn.p.perception",willpower:"earthdawn.w.willpower",charisma:"earthdawn.c.charisma"},r={dexterity:"earthdawn.d.DEX",strength:"earthdawn.s.STR",toughness:"earthdawn.t.TOU",perception:"earthdawn.p.PER",willpower:"earthdawn.w.WIL",charisma:"earthdawn.c.CHA",initiative:"earthdawn.i.INI"},l=15,c=Object.values(Object.assign({},[...Array(15).keys()].map((t=>{const e=t+1;return{id:`circle${e}spells`,name:`Circle ${e}`,type:"system"}})))).reduce(((t,e)=>(t[e.id]=e,t)),{}),d=s.reduce(((t,e)=>{const a=`${e}Spells`;return{...t,[a]:{id:a,name:e.charAt(0).toUpperCase()+e.slice(1),type:"system"}}}),{}),p={melee:"fa-thin fa-sword",ranged:"fa-thin fa-bow-arrow",thrown:"fa-thin fa-bullseye-arrow",unarmed:"fa-thin fa-hand-fist"},m="fas fa-circle-c",h="fas fa-sun",y="fas fa-circle-r",u={.5:"fas fa-adjust",1:"fas fa-check",2:"fas fa-check-double"},w={attributes:{id:"attributes",name:"earthdawn.a.attributes",type:"system"},combat:{id:"combat",name:"tokenActionHud.combat",type:"system"},combatUtilities:{id:"combatUtilities",name:"tokenActionHud.combat",type:"system"},other:{id:"other",name:"earthdawn.o.other",type:"system"},system:{id:"system",name:"tokenActionHud.ed4e.system",type:"system"},favorites:{id:"favorites",name:"tokenActionHud.ed4e.groupTitles.favorites",type:"system"},weapons:{id:"weapons",name:"earthdawn.w.weapons",type:"system"},armors:{id:"armors",name:"earthdawn.a.armors",type:"system"},shields:{id:"shields",name:"earthdawn.s.shields",type:"system"},equipment:{id:"equipment",name:"earthdawn.e.equipment",type:"system"},equipped:{id:"equipped",name:"earthdawn.e.equipped",type:"system"},unequipped:{id:"unequipped",name:"tokenActionHud.ed4e.unequipped",type:"system"},weaponAttack:{id:"weaponAttack",name:"tokenActionHud.ed4e.attack",type:"system"},threadItems:{id:"threadItems",name:"earthdawn.t.threadItems",type:"system"},optionsModifier:{id:"optionsModifier",name:"earthdawn.c.combatOptions",type:"system"},combatActions:{id:"combatActions",name:"earthdawn.a.actions",type:"system"},talents:{id:"talents",name:"earthdawn.t.talents",type:"system"},skills:{id:"skills",name:"earthdawn.s.skills",type:"system"},standard:{id:"standard",name:"earthdawn.s.standard",type:"system"},simple:{id:"simple",name:"earthdawn.s.sustained",type:"system"},free:{id:"free",name:"earthdawn.f.free",type:"system"},sustained:{id:"sustained",name:"earthdawn.s.sustained",type:"system"},na:{id:"na",name:"tokenActionHud.ed4e.na",type:"system"},token:{id:"token",name:"tokenActionHud.token",type:"system"},utility:{id:"utility",name:"tokenActionHud.utility",type:"system"},matrices:{id:"matrices",name:"tokenActionHud.ed4e.groupTitles.matrix",type:"system"},powers:{id:"powers",name:"earthdawn.p.powers",type:"system"},powerAttacks:{id:"powerAttacks",name:"earthdawn.a.attacks",type:"system"},powerManeuvers:{id:"powerManeuvers",name:"earthdawn.m.maneuvers",type:"system"},powerPowers:{id:"powerPowers",name:"earthdawn.p.powers",type:"system"},effects:{id:"effects",name:"earthdawn.e.effects",type:"system"},...c,...d},g={Everyday:"earthdawn.a.availabilityEveryday",Average:"earthdawn.a.availabilityAverage",Unusual:"earthdawn.a.availabilityUnusual",Rare:"earthdawn.a.availabilityRare",VeryRare:"earthdawn.a.availabilityVeryRare"};let f=null;Hooks.once("tokenActionHudCoreApiReady",(async e=>{f=class Utils{static getSetting(a,i=null){let s=i??null;try{s=game.settings.get(t.ID,a)}catch{e.api.Logger.debug(`Setting '${a}' not found`)}return s}static async setSetting(a,i){try{i=await game.settings.set(t.ID,a,i),e.api.Logger.debug(`Setting '${a}' set to '${i}'`)}catch{e.api.Logger.debug(`Setting '${a}' not found`)}}}}));let b=null;Hooks.once("tokenActionHudCoreApiReady",(async t=>{b=class ActionHandler extends t.api.ActionHandler{i18n=game.i18n;actors=null;tokens=null;actorType=null;items=null;abbreviateAttributes;showWeaponAmmoInfo;talentSkillGroupIds=null;spellGroupIds=null;inventoryGroupIds=null;powerGroupIds=null;async buildSystemActions(e){if(this.actors=this.actor?[this.actor]:this.#t(),this.tokens=this.token?[this.token]:this.#e(),this.actorType=this.actor?.type,this.actor){let e=this.actor.items;e=t.api.Utils.sortItemsByName(e),this.items=e}this.abbreviateAttributes=f.getSetting("abbreviateAttributes"),this.showWeaponAmmoInfo=f.getSetting("showWeaponAmmoInfo"),this.talentSkillGroupIds=["standard","simple","free","sustained","na"],this.spellGroupIds=Array.from({length:15},((t,e)=>`circle${e+1}spells`)),this.spellGroupIds.push(...Array.from(s,((t,e)=>`${t}Spells`))),this.powerGroupIds=["powerAttacks","powerManeuvers","powerPowers"],this.actor?("pc"!==this.actor.type&&"npc"!==this.actor.type||(this.inventoryGroupIds=["equipped","unequipped","threadItems","armors","equipment","shields","weapons"],await this.#a()),"creature"===this.actor.type&&await this.#i()):await this.#s()}async#a(){await Promise.all([this.#n(),this.#o("talent"),this.#o("skill"),this.#r(),this.#l(),this.#c(),this.#d(),this.#p()]),this.#m(),this.#h()}async#i(){await Promise.all([this.#y(),this.#d(),this.#p()]),this.#m(),this.#h()}async#s(){this.#m(),this.#h()}#m(){this.#u(),this.#w(),this.actor&&this.#g()}#g(){const t="creature"===this.actor?.type,e={"earthdawn.u.useKarma":"usekarma"};let a=["earthdawn.u.useKarma"].map((t=>({id:`action_system_${t}`,name:this.i18n.localize(t),encodedValue:["toggle",e[t]].join(this.delimiter),cssClass:"true"===this.actor.system.usekarma?"toggle active":"toggle"}))).filter((t=>!!t)).sort(((t,e)=>t.name.localeCompare(e.name)));const i={id:"system",type:"system"};t||this.addActions(a,i)}#w(){const t="creature"===this.actor?.type;let e=[{id:null,name:this.i18n.localize("earthdawn.r.recovery"),encodedValue:["recovery","recovery"].join(this.delimiter),info1:{text:this.actor?`${this.actor.system.recoverytestscurrent??0}/${this.actor.system.recoverytestsrefreshFinal??0}`:"",title:this.actor?this.i18n.localize("tokenActionHud.ed4e.infoTitles.recoveryTests"):""}}];t||e.push({id:"action_other_newDay",name:this.i18n.localize("earthdawn.n.newDay"),encodedValue:["newday","newday"].join(this.delimiter)},{id:"action_other_halfMagic",name:this.i18n.localize("earthdawn.h.halfMagic"),encodedValue:["halfmagic","halfmagic"].join(this.delimiter)});this.addActions(e,{id:"other",type:"system"})}#u(){let t=n.map((t=>({id:`action_attribute_${t}`,name:this.i18n.localize(this.abbreviateAttributes?r[t]:o[t]),encodedValue:["attribute",t].join(this.delimiter),tooltip:this.i18n.format("tokenActionHud.ed4e.tooltips.attributeTest",{attribute:this.i18n.localize(t)}),info1:{text:this.actor?`${this.actor.system[`${t}Step`]}`:"",title:this.actor?this.i18n.localize("tokenActionHud.ed4e.infoTitles.attributeStep"):""}})));this.addActions(t,{id:"attributes",type:"system"})}async#n(){if("creature"===this.actor.type)return;const t=Array.from(this.actor.items.values()).filter((t=>"true"===t.system.favorite));if(t.length<1)return;const e={id:"favorites",type:"system"};let a=await Promise.all(t.map((async t=>await this.#f(t.type,t,e))));a.sort(((t,e)=>t.name.localeCompare(e.name))),await this.addActions(a,e)}async#o(e){const a=new Map;for(const[t,i]of this.items){i.type===e&&a.set(t,i)}if(0===a.size)return;t.api.Logger.debug(`Building group "${e}s"`);const i=new Map;for(const[t,e]of a){const a=e.system.action?.toLowerCase()??"na";i.has(a)||i.set(a,new Map),i.get(a).set(t,e)}const s={standard:this.i18n.localize("earthdawn.s.standard"),simple:this.i18n.localize("earthdawn.s.simple"),free:this.i18n.localize("earthdawn.s.free"),sustained:this.i18n.localize("earthdawn.s.sustained"),na:this.i18n.localize("tokenActionHud.ed4e.na")};for(const t of this.talentSkillGroupIds){if(!i.has(t))continue;const a={id:t,nestId:`${e}s_${t}`,name:s[t]??"",type:"system"},n=i.get(t);await this.#b(n,a,e)}const n=`${e}s`,o={id:n,nestId:[n,n].join("_"),type:"system"};await this.#b(a,o,e)}async#r(){const t=new Map;for(const[e,a]of this.items){if("spell"===a.type){const i=`circle${a.system.circle}spells`,s=`${a.system.discipline.toLowerCase()}Spells`;this.#k(t,i,e,a),this.#k(t,s,e,a)}}const e=[...Array(15).keys()].map((t=>t+1));let a={};for(const t of e)a[`circle${t}spells`]={spellCircle:t,name:`${this.i18n.localize("earthdawn.c.circle")} ${t}`};for(const t of s)a[`${t}Spells`]={discipline:t,name:t.charAt(0).toUpperCase()+t.slice(1)};for(const e of this.spellGroupIds){const i=a[e].name;if(!t.has(e))continue;const s={id:e,name:i,type:"system"},n=t.get(e);await this.#b(n,s,"spell")}}async#y(){if(this.items.size<1)return;const t=new Map;for(const[e,a]of this.items)if("attack"===a.type){switch(a.system.powerType.toLowerCase()){case"attack":this.#k(t,"powerAttacks",e,a);break;case"maneuver":this.#k(t,"powerManeuvers",e,a);break;case"power":this.#k(t,"powerPowers",e,a)}}const e={powerAttacks:this.i18n.localize("earthdawn.a.attacks"),powerManeuvers:this.i18n.localize("earthdawn.m.maneuvers"),powerPowers:this.i18n.localize("earthdawn.p.powers")};for(const a of this.powerGroupIds){if(!t.has(a))continue;const i={id:a,name:e[a],type:"system"},s=t.get(a);await this.#b(s,i,"power")}}async#c(){if(this.items.size<1)return;const t=new Map;for(const[e,a]of this.items){const i=a.system.hasOwnProperty("worn"),s=a.system.isthread,n=!!a.system.worn,o=a.type;n?this.#k(t,"equipped",e,a):i&&this.#k(t,"unequipped",e,a),s&&this.#k(t,"threadItems",e,a),"armor"===o&&this.#k(t,"armors",e,a),"equipment"===o&&this.#k(t,"equipment",e,a),"shield"===o&&this.#k(t,"shields",e,a),"weapon"===o&&this.#k(t,"weapons",e,a)}const e={equipped:this.i18n.localize("earthdawn.e.equipped"),unequipped:this.i18n.localize("tokenActionHud.ed4e.unequipped"),threadItems:this.i18n.localize("earthdawn.t.threadItems"),armors:this.i18n.localize("earthdawn.a.armors"),equipment:this.i18n.localize("earthdawn.e.equipment"),shields:this.i18n.localize("earthdawn.s.shields"),weapons:this.i18n.localize("earthdawn.w.weapons")};for(const a of this.inventoryGroupIds){if(!t.has(a))continue;const i={id:a,name:e[a],type:"system"},s=t.get(a);await this.#b(s,i)}}async#d(){const t=this.actor.effects;if(0===t.size)return;const e=new Map;for(const[a,i]of t.entries())e.set(a,i);await this.#b(e,{id:"effects",nestId:"effects_effects",type:"system"},"effect")}async#b(t,e,a="item"){if(0===t.size)return;if(!("string"==typeof e?e:e?.id))return;const i=await Promise.all([...t].map((async t=>await this.#f(a,t[1],e))));this.addActions(i,e)}async#f(e,a,s){const n=a.id??a._id;let o=a?.name??a?.label;const r=`${`${t.api.Utils.i18n(i[e])}: `??""}${o}`;r||t.api.Logger.debug("No list name for: ",{actionType:e,entity:a,groupData:s});let l="";if(Object.hasOwn(a,"disabled")){l=`toggle${a.disabled?"":" active"}`}else if(Object.hasOwn(a.system??{},"worn")){l=`toggle${a.system.worn?" active":""}`}const c=[e,n].join(this.delimiter),d=t.api.Utils.getImage(a),p=this.#A(a),m=p.icon1,h=p.icon2,y=p.icon3,u=this.#v(a,s),w=u?.info1,g=u?.info2,f=u?.info3,b=await this.#$(a);return{id:n,name:o,encodedValue:c,cssClass:l,img:d,icon1:m,icon2:h,icon3:y,info1:w,info2:g,info3:f,listName:r,tooltip:await this.#I(b)}}#v(t,e){let a,i,s;switch(t.type){case"talent":case"skill":a={text:`${t.system.finalranks??t.system.ranks}`,title:this.i18n.localize("earthdawn.r.rank")},i={text:this.i18n.localize(r[t.system.attribute.replace("Step","")]??"earthdawn.n.none"),title:this.i18n.localize("earthdawn.a.attribute")},t.system.strain>0&&(s={text:t.system.strain.toString(),title:this.i18n.localize("earthdawn.s.strain"),class:"tah-spotlight"});break;case"attack":"Maneuver"!==t.system.powerType&&(t.system.attackstep>0||t.system.damagestep>0)&&(a={text:`${t.system.attackstep}`,title:this.i18n.localize("earthdawn.r.rollStep")},i={text:`${t.system.damagestep}`,title:this.i18n.localize("earthdawn.d.damageStep")}),t.system.strain>0&&(s={text:t.system.strain.toString(),title:this.i18n.localize("earthdawn.s.strain"),class:"tah-spotlight"});break;case"spell":a={text:`${t.system.threadsrequired}`,title:this.i18n.localize("earthdawn.s.spellThreads")},i=e.id.includes("circle")?{text:t.system.discipline??this.i18n.localize("tokenActionHud.ed4e.na"),title:this.i18n.localize("earthdawn.d.discipline")}:{text:`${t.system.circle}`,title:this.i18n.localize("earthdawn.c.circle")},s=null;break;case"equipment":t.system.amount>1&&(a={text:`${t.system.amount}x`,title:this.i18n.localize("earthdawn.a.amount")});break;case"armor":a={text:`${t.system.physicalArmorFinal} ${this.i18n.localize("tokenActionHud.ed4e.abbreviations.physicalArmor")}`,title:this.i18n.localize("earthdawn.p.physicalArmor")},i={text:`${t.system.mysticArmorFinal} ${this.i18n.localize("tokenActionHud.ed4e.abbreviations.mysticArmor")}`,title:this.i18n.localize("earthdawn.m.mysticArmor")};break;case"shield":a={text:`${t.system.physicaldefense} ${this.i18n.localize("tokenActionHud.ed4e.abbreviations.physicalDefense")}`,title:this.i18n.localize("earthdawn.p.physicalDefense")},i={text:`${t.system.mysticdefense} ${this.i18n.localize("tokenActionHud.ed4e.abbreviations.mysticDefense")}`,title:this.i18n.localize("earthdawn.m.mysticDefense")},s={text:`${t.system.shatterthreshold}`,title:this.i18n.localize("earthdawn.s.shatterThreshold")};break;case"weapon":a={text:`${t.system.damageTotal}`,title:this.i18n.localize("tokenActionHud.ed4e.tooltips.info.weaponStepTotal")},["ranged","thrown"].includes(t.system.weapontype)&&(i={text:`${t.system.shortrange}/${t.system.longrange}`,title:this.i18n.localize("tokenActionHud.ed4e.tooltips.info.weaponRange")},s={text:`${t.system.ammo}`,title:this.i18n.localize("tokenActionHud.ed4e.tooltips.info.weaponAmmo")})}return{info1:a,info2:i,info3:s}}#A(t){let e,a,i;switch(t.type){case"talent":case"skill":case"attack":t.system.strain>0&&(e=`<i class="fa-thin fa-droplet" title="${this.i18n.localize("earthdawn.s.strain")}"></i>`);break;case"weapon":e=`<i class="${p[t.system.weapontype.toLowerCase()]}" title="${this.i18n.localize("earthdawn.w.weaponType")}"></i>`;case"armor":(t.system.timesForged>0||t.system.timesForgedMystic>0||t.system.timesForgedPhysical>0)&&(a=`<i class="fa-thin fa-hammer-crash" title="${this.i18n.localize("tokenActionHud.ed4e.forged")}"></i>`)}return t.system?.isthread&&(i=`<i class="fa-thin fa-wand-sparkles" title="${this.i18n.localize("earthdawn.t.threadItem")}"></i>`),{icon1:e,icon2:a,icon3:i}}#t(){const t=["pc","npc","creature"],e=canvas.tokens.controlled.filter((t=>t.actor)).map((t=>t.actor));return e.every((e=>t.includes(e.type)))?e:[]}#e(){const t=["pc","npc","creature"],e=canvas.tokens.controlled;return e.filter((t=>t.actor)).map((t=>t.actor)).every((e=>t.includes(e.type)))?e:[]}#k(t,e,a,i){t.has(e)||t.set(e,new Map),t.get(e).set(a,i)}#$(t){if("none"===this.tooltipsSetting)return"";const e=t?.name??"";if("none"===this.tooltipsSetting)return"";const a="string"==typeof t?.system?.description?t?.system?.description:t?.system?.description?.value??"",i=t?.availability??null;return{name:e,description:a,properties:this.#z(t),rarity:i,tags:this.#H(t)}}async#I(e){if("none"===this.tooltipsSetting)return"";if("string"==typeof e)return e;const a=e.name,i=`<h3>${a}</h3>`,s=e?.descriptionLocalized??await TextEditor.enrichHTML(this.i18n.localize(e?.description??""),{async:!0}),n=e?.rarity?`<span class="tah-tag ${e.rarity}">${t.api.Utils.i18n(RARITY[e.rarity])}</span>`:"",o=e?.properties?`<div class="tah-properties">${e.properties.map((e=>`<span class="tah-property">${t.api.Utils.i18n(e)}</span>`)).join("")}</div>`:"",r=[n,e?.tags?e.tags.map((e=>`<span class="tah-tag">${t.api.Utils.i18n(e.label??e)}</span>`)).join(""):""].join(""),l=r?`<div class="tah-tags">${r}</div>`:"";return s||l?`<div>${i}${l?`<div class="tah-tags-wrapper">${l}</div>`:""}${s}${o}</div>`:a}#h(){const e="utility",a={initiative:{id:"initiative",name:t.api.Utils.i18n("tokenActionHud.ed4e.rollInitiative")},endTurn:{id:"endTurn",name:t.api.Utils.i18n("tokenActionHud.endTurn")}};game.combat?.current?.tokenId!==this.token?.id&&delete a.endTurn;const s=Object.entries(a).map((a=>{const s=a[1].id,n=a[1].name,o=`${`${t.api.Utils.i18n(i[e])}: `??""}${n}`,r=[e,s].join(this.delimiter),l={};let c="";if("initiative"===a[0]&&game.combat){const t=canvas.tokens.controlled.map((t=>t.id)),e=game.combat.combatants.filter((e=>t.includes(e.tokenId)));if(1===e.length){const t=e[0].initiative;l.class="tah-spotlight",l.text=t}c=`toggle${e.length>0&&e.every((t=>t?.initiative))?" active":""}`}return{id:s,name:n,encodedValue:r,info1:l,cssClass:c,listName:o}}));this.addActions(s,{id:"combatUtilities",type:"system"})}async#p(){const t={id:"weaponAttack",name:this.i18n.localize("tokenActionHud.ed4e.attack"),type:"system"},e=this.actor.items.filter((t=>"weapon"===t.type&&t.system.worn)),a=await Promise.all(e.map((async e=>await this.#f("weaponAttack",e,t))));await this.addActions(a,t);const i={"earthdawn.c.combatOptionsAggressive":"tactics.aggressive","earthdawn.c.combatOptionsDefensive":"tactics.defensive","earthdawn.c.combatModifierHarried":"tactics.harried","earthdawn.c.combatModifierKnockedDown":"tactics.knockeddown"};let s=["earthdawn.c.combatOptionsAggressive","earthdawn.c.combatOptionsDefensive","earthdawn.c.combatModifierHarried","earthdawn.c.combatModifierKnockedDown"].map((t=>({id:`combatTactic_${t}`,name:this.i18n.localize(t),encodedValue:["toggle",i[t]].join(this.delimiter),cssClass:!0===this.actor.system.tactics[i[t].split(".")[1]]?"toggle active":"toggle"}))).sort(((t,e)=>t.name.localeCompare(e.name)));await this.addActions(s,{id:"optionsModifier",name:"earthdawn.c.combatOptions",type:"system"});const n={id:"combatActions",name:this.i18n.localize("earthdawn.a.actions"),type:"system"},o=[{id:"combatAction_takeDamage",name:this.i18n.localize("earthdawn.t.takeDamage"),encodedValue:["takedamage","takedamage"].join(this.delimiter)},{id:"combatAction_knockdownTest",name:this.i18n.localize("earthdawn.c.combatOptionsKnockdownTest"),encodedValue:["knockdowntest","knockdowntest"].join(this.delimiter)},{id:"combatAction_jumpUp",name:this.i18n.localize("earthdawn.c.combatOptionsJumpUp"),encodedValue:["jumpup","jumpup"].join(this.delimiter)}];await this.addActions(o,n)}async#l(){const t=this.actor.items.filter((t=>"spellmatrix"===t.type));if(t.length<1)return;const e={id:"matrices"};for(const a of t){const t={id:`matrix_${a.id}`,name:a.name,type:"system-derived",selected:!0,info1:{text:a.system.currentspell,info:this.i18n.localize("tokenActionHud.ed4e.tooltips.info.matrixSpell"),class:"tah-spotlight"},info2:{text:`${a.system.totalthreads}/${a.system.totalthreadsneeded}`,title:this.i18n.localize("tokenActionHud.ed4e.tooltips.info.matrixThreads")}},i={matrixAttune:"earthdawn.a.attune",matrixWeave:"earthdawn.m.matrixWeaveRed",matrixCast:"earthdawn.m.matrixCastRed",matrixClear:"earthdawn.m.matrixClearRed"},s=Array.from(Object.entries(i),(([t,e])=>({id:a.id,name:this.i18n.localize(e),encodedValue:[t,a.id].join(this.delimiter),selected:!0})));await this.addGroup(t,e,!0),await this.addActions(s,t)}}#z(t){let e=[];switch(t.type??"effect"){case"armor":e.push(`${t.system.Aphysicalarmor} + ${t.system.timesForgedPhysical} ${this.i18n.localize("tokenActionHud.ed4e.abbreviations.physicalArmor")}`,`${t.system.Amysticarmor} + ${t.system.timesForgedMystic} ${this.i18n.localize("tokenActionHud.ed4e.abbreviations.mysticArmor")}`,this.#M(t.system.armorPenalty));break;case"attack":e.push(`${this.i18n.localize("earthdawn.a.actionStep")} ${t.system.attackstep}`,`${this.i18n.localize("earthdawn.d.damageStep")} ${t.system.damagestep}`);break;case"devotion":e.push(`${this.#T(t.system.action.toLowerCase())}`,`${this.#S(t.system.attribute)}`,`${this.#x(strain)}`,`${t.system.devotionRequired?this.i18n.localize("earthdawn.d.devotion"):""}`);break;case"knack":case"skill":case"talent":e.push(this.#T(t.system.action),this.#S(t.system.attribute),this.#x(t.system.strain));break;case"shield":e.push(`${t.system.physicaldefense} ${this.i18n.localize("tokenActionHud.ed4e.abbreviations.physicalDefense")}`,`${t.system.mysticdefense} ${this.i18n.localize("tokenActionHud.ed4e.abbreviations.mysticDefense")}`,this.#M(t.system.initiativepenalty),t.system.shatterthreshold?`${t.system.shatterthreshold} ${this.i18n.localize("tokenActionHud.ed4e.shatter")}`:"");break;case"spell":e.push(t.system.circle?`${this.i18n.localize("earthdawn.c.circle")} ${t.system.circle}`:"",`${this.i18n.localize("tokenActionHud.ed4e.threads")} ${t.system.threadsrequired}`,`${this.i18n.localize("tokenActionHud.ed4e.weaving")} ${t.system.weavingdifficulty}/${t.system.reattunedifficulty}`,`${this.i18n.localize("tokenActionHud.ed4e.casting")} ${t.system.castingdifficulty}`);break;case"weapon":const a=t.system.weapontype.toLowerCase();e.push(`${this.i18n.localize(`earthdawn.${a[0]}.${a}`)}`,`${t.system.damagestep} + ${this.#S(t.system.damageattribute)} = ${t.system.damageTotal}`,t.system.timesForged?`+${t.system.timesForged}`:"",t.system.longrange?`${this.i18n.localize("earthdawn.r.range")} ${t.system.shortrange}/${t.system.longrange}`:"")}return e.filter((t=>String(t).trim()))}#T(t){const e=t?.toLowerCase();return e?`${this.i18n.localize("earthdawn.a.action")}: ${this.i18n.localize(`earthdawn.${e[0]}.${e}`)}`:""}#S(t){return t?`${this.i18n.localize(r[t.replace("Step","")])}`:""}#x(t){return t?`${t} ${this.i18n.localize("earthdawn.s.strain")}`:""}#M(t){return t?`-${t} ${this.i18n.localize("earthdawn.i.INI")}`:""}#H(t){const e=[];switch(t.type??"effect"){case"knack":e.push(t.system.sourceTalentName??"");break;case"spell":e.push(t.system.discipline??"")}return e}}}));let k=null;Hooks.once("tokenActionHudCoreApiReady",(async t=>{const e=w;Object.values(e).forEach((e=>{e.name=t.api.Utils.i18n(e.name),e.listName=`Group: ${t.api.Utils.i18n(e.name)}`}));const a=Object.values(e);k={layout:[{nestId:"general",id:"general",name:t.api.Utils.i18n("tokenActionHud.ed4e.groupTitles.general"),groups:[{...e.attributes,nestId:"general_attributes"},{...e.other,nestId:"general_other"},{...e.system,nestId:"general_system"}]},{nestId:"powers",id:"powers",name:t.api.Utils.i18n("earthdawn.p.powers"),groups:[{...e.powerAttacks,nestId:"powers_powerAttacks"},{...e.powerManeuvers,nestId:"powers_powerManeuvers"},{...e.powerPowers,nestId:"powers_powerPowers"}]},{nestId:"favorites",id:"favorites",name:t.api.Utils.i18n("tokenActionHud.ed4e.groupTitles.favorites"),groups:[{...e.favorites,nestId:"favorites_favorites"}]},{nestId:"talents",id:"talents",name:t.api.Utils.i18n("earthdawn.t.talents"),type:"system",groups:[{...e.standard,nestId:"talents_standard"},{...e.simple,nestId:"talents_simple"},{...e.free,nestId:"talents_free"},{...e.sustained,nestId:"talents_sustained"},{...e.na,nestId:"talents_na"}]},{nestId:"skills",id:"skills",name:t.api.Utils.i18n("earthdawn.s.skills"),groups:[{...e.standard,nestId:"skills_standard"},{...e.simple,nestId:"skills_simple"},{...e.free,nestId:"skills_free"},{...e.sustained,nestId:"skills_sustained"},{...e.na,nestId:"skills_na"}]},{nestId:"spells",id:"spells",name:t.api.Utils.i18n("earthdawn.s.spells"),groups:Array.from(Object.values(c),(t=>(t.nestId=`spells_${t.id}`,t)))},{nestId:"inventory",id:"inventory",name:t.api.Utils.i18n("earthdawn.i.inventory"),groups:[{...e.weapons,nestId:"inventory_weapons"},{...e.armors,nestId:"inventory_armors"},{...e.shields,nestId:"inventory_shields"},{...e.equipment,nestId:"inventory_equipment"}]},{nestId:"matrices",id:"matrices",name:t.api.Utils.i18n("tokenActionHud.ed4e.groupTitles.matrix")},{nestId:"combat",id:"combat",name:t.api.Utils.i18n("earthdawn.c.combat"),groups:[{...e.weaponAttack,nestId:"combat_weaponAttack"},{...e.optionsModifier,nestId:"combat_optionsModifier"},{...e.combatActions,nestId:"combat_actions"}]},{nestId:"effects",id:"effects",name:t.api.Utils.i18n("earthdawn.e.effects"),groups:[{...e.effects,nestId:"effects_effects"}]},{nestId:"utility",id:"utility",name:t.api.Utils.i18n("tokenActionHud.utility"),groups:[{...e.combatUtilities,nestId:"utility_combatUtilities"},{...e.token,nestId:"utility_token"}]}],groups:a}}));let A=null;function register(e){game.settings.register(t.ID,"abbreviateAttributes",{name:game.i18n.localize("tokenActionHud.ed4e.settings.abbreviateAttributes.name"),hint:game.i18n.localize("tokenActionHud.ed4e.settings.abbreviateAttributes.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:t=>{e(t)}}),game.settings.register(t.ID,"showWeaponAmmoInfo",{name:game.i18n.localize("tokenActionHud.ed4e.settings.showWeaponAmmoInfo.name"),hint:game.i18n.localize("tokenActionHud.ed4e.settings.showWeaponAmmoInfo.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:t=>{e(t)}})}Hooks.once("tokenActionHudCoreApiReady",(async t=>{A=class RollHandler extends t.api.RollHandler{async doHandleActionEvent(t,e){let a=e.split(this.delimiter);2!==a.length&&super.throwInvalidValueErr();let i=a[0],s=a[1];if(this.actor)await this.#_(t,i,this.actor,this.token,s);else for(const e of canvas.tokens.controlled){const a=e.actor;await this.#_(t,i,a,e,s)}}async#_(t,e,a,i,s){if(this.isRenderItem())["skill","talent","power","item","spell"].includes(e)?this.doRenderItem(a,s):"effect"===e&&a.effects.get(s).sheet.render(!0);else switch(e){case"skill":case"talent":this.rollTalentMacro(t,a,i,s);break;case"attack":case"power":case"maneuver":this.handleCreatureActionMacro(t,a,i,s);break;case"item":await this.rollInventoryMacro(t,a,i,s);break;case"toggle":await this.toggleDataProperty(t,a,i,s);break;case"attribute":this.rollAttributeMacro(t,a,i,s);break;case"utility":await this.#U(t,a,i,s);break;case"recovery":a.recoveryTest();break;case"newday":a.newDay();break;case"halfmagic":a.halfMagic();break;case"matrixAttune":a.attuneMatrix(a.items.get(s));break;case"matrixWeave":a.weaveThread(a.items.get(s));break;case"matrixCast":a.castSpell(a.items.get(s));break;case"matrixClear":a.clearMatrix(a.items.get(s));break;case"weaponAttack":a.rollPrep({weaponID:s,rolltype:"attack"});break;case"takedamage":await this.takeDamage(a);break;case"knockdowntest":a.knockdownTest({});break;case"jumpup":a.jumpUpTest();break;case"effect":await this.#C(t,a,s)}}rollAttributeMacro(t,e,a,i){e.rollPrep({attribute:`${i.split(".").slice(-1)}Step`,name:i})}rollTalentMacro(t,e,a,i){e.rollPrep({talentID:i})}async rollInventoryMacro(t,e,a,i){e.items.get(i).system.hasOwnProperty("worn")&&await this.toggleItemWornProperty(t,e,a,i)}async toggleDataProperty(t,e,a,i){if(i.includes("tactics")){const t=i.split(".")[1],a={system:{tactics:{}}};a.system.tactics[t]=!e.system.tactics[t],await e.update(a)}else{const t=e.system[i],a="string"===typeof t?this._toggleBooleanString(t):!t;await e.update({system:{[i]:a}})}Hooks.callAll("forceUpdateTokenActionHud")}async toggleItemWornProperty(t,e,a,i){const s=e.items.get(i),n=s.system.worn;let o="string"===typeof n?this._toggleBooleanString(n):!n;await s.update({system:{worn:o}}),Hooks.callAll("forceUpdateTokenActionHud")}_toggleBooleanString(t){return t.toLowerCase().includes("true")?"false":t.toLowerCase().includes("false")?"true":"false"}handleCreatureActionMacro(t,e,a,i){const s=e.items.get(i);if(0!==s.system.attackstep){const t=0,a=s.system.strain?s.system.strain:0,n=0;let o="Attack"===s.system.powerType?"attack":s.system.attackstep>0?"test":"";const r={itemID:i,steps:s.system.attackstep,talent:s.name,strain:a,type:o,karma:n,modifier:t};e.NPCtest(r)}else e.items.get(i).sheet.render(!0)}async takeDamage(e){let a=await new Promise((e=>{new Dialog({title:t.api.Utils.i18n("earthdawn.t.takeDamage"),content:`\n          <div style="float: left">\n              <label>${t.api.Utils.i18n("earthdawn.d.damage")}: </label>\n              <input id="damage_box" value=0 autofocus/>\n          </div>\n          <div>\n              <label>${t.api.Utils.i18n("earthdawn.t.type")}: </label>\n              <select id="type_box">\n                <option value="physical">Physical</option>\n                <option value="mystic">Mystic</option>\n              </select>\n          </div>\n          <div>\n            <label>${t.api.Utils.i18n("earthdawn.i.ignoreArmor")}?</label>\n            <input type="checkbox" id="ignore_box"/>\n          </div>`,buttons:{ok:{label:t.api.Utils.i18n("earthdawn.o.ok"),callback:t=>{e({damage:t.find("#damage_box").val(),type:t.find("#type_box").val(),ignore:t.find("#ignore_box:checked")})}}},default:"ok"}).render(!0)}));a.ignorearmor=a.ignore.length>0,await e.takeDamage(a)}async#U(t,e,a,i){switch(i){case"endTurn":if(!a)break;game.combat?.current?.tokenId===a.id&&await(game.combat?.nextTurn());break;case"initiative":await this.#P(e)}Hooks.callAll("forceUpdateTokenActionHud")}async#P(t){t&&(await t.rollInitiative({createCombatants:!0}),Hooks.callAll("forceUpdateTokenActionHud"))}async#C(t,e,a){const i=("find"in e.effects.entries?e.effects.entries:e.effects).find((t=>t.id===a));i&&(await i.update({disabled:!i.disabled}),Hooks.callAll("forceUpdateTokenActionHud"))}}}));let v=null;Hooks.once("tokenActionHudCoreApiReady",(async t=>{v=class SystemManager extends t.api.SystemManager{doGetCategoryManager(e){return new t.api.CategoryManager}doGetActionHandler(t){return new b(t)}getAvailableRollHandlers(){return{core:"Core Earthdawn 4th Edition"}}doGetRollHandler(t){let e;return e=new A,e}doRegisterSettings(t){register(t)}async doRegisterDefaultFlags(){return k}}})),Hooks.on("tokenActionHudCoreApiReady",(async()=>{const e=game.modules.get(t.ID);e.api={requiredCoreModuleVersion:"1.4",SystemManager:v},Hooks.call("tokenActionHudSystemReady",e)}));export{i as ACTION_TYPE,n as ATTRIBUTES,r as ATTRIBUTES_ABBREVIATED,o as ATTRIBUTES_FULL_NAME,b as ActionHandler,m as CONCENTRATION_ICON,e as CORE_MODULE,k as DEFAULTS,w as GROUP,l as MAX_SPELL_CIRCLE,t as MODULE,h as PREPARED_ICON,u as PROFICIENCY_LEVEL_ICON,g as RARITY,a as REQUIRED_CORE_MODULE_VERSION,y as RITUAL_ICON,A as RollHandler,s as SPELLCASTING_DISCIPLINES,v as SystemManager,f as Utils,p as WEAPON_TYPE_ICON,c as circleGroupData,d as disciplineGroupData,register};

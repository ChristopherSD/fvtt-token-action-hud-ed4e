const e={ID:"token-action-hud-ed4e"},t={ID:"token-action-hud-core"},a="1.4",s={talent:"earthdawn.t.talent",skill:"earthdawn.s.skill",spell:"earthdawn.s.spell",matrix:"tokenActionHud.ed4e.groupTitles.matrix",item:"tokenActionHud.ed4e.item",utility:"tokenActionHud.ed4e.utility",weaponAttack:"earthdawn.a.attack",power:"earthdawn.p.power"},i=["elementalist","illusionist","nethermancer","shaman","wizard"],n=["dexterity","strength","toughness","perception","willpower","charisma"],o={dexterity:"earthdawn.d.dexterity",strength:"earthdawn.s.strength",toughness:"earthdawn.t.toughness",perception:"earthdawn.p.perception",willpower:"earthdawn.w.willpower",charisma:"earthdawn.c.charisma"},r={dexterity:"earthdawn.d.DEX",strength:"earthdawn.s.STR",toughness:"earthdawn.t.TOU",perception:"earthdawn.p.PER",willpower:"earthdawn.w.WIL",charisma:"earthdawn.c.CHA",initiative:"earthdawn.i.INI"},l=15,d=Object.values(Object.assign({},[...Array(15).keys()].map((e=>{const t=e+1;return{id:`circle${t}spells`,name:`Circle ${t}`,type:"system"}})))).reduce(((e,t)=>(e[t.id]=t,e)),{}),c=i.reduce(((e,t)=>{const a=`${t}Spells`;return{...e,[a]:{id:a,name:t.charAt(0).toUpperCase()+t.slice(1),type:"system"}}}),{}),m={melee:"fa-thin fa-sword",ranged:"fa-thin fa-bow-arrow",thrown:"fa-thin fa-bullseye-arrow",unarmed:"fa-thin fa-hand-fist"},p="fas fa-circle-c",h="fas fa-sun",u="fas fa-circle-r",y={.5:"fas fa-adjust",1:"fas fa-check",2:"fas fa-check-double"},w={attributes:{id:"attributes",name:"earthdawn.a.attributes",type:"system"},combat:{id:"combat",name:"tokenActionHud.combat",type:"system"},combatUtilities:{id:"combatUtilities",name:"tokenActionHud.combat",type:"system"},other:{id:"other",name:"earthdawn.o.other",type:"system"},system:{id:"system",name:"tokenActionHud.ed4e.system",type:"system"},favorites:{id:"favorites",name:"tokenActionHud.ed4e.groupTitles.favorites",type:"system"},weapons:{id:"weapons",name:"earthdawn.w.weapons",type:"system"},armors:{id:"armors",name:"earthdawn.a.armors",type:"system"},shields:{id:"shields",name:"earthdawn.s.shields",type:"system"},equipment:{id:"equipment",name:"earthdawn.e.equipment",type:"system"},equipped:{id:"equipped",name:"earthdawn.e.equipped",type:"system"},unequipped:{id:"unequipped",name:"tokenActionHud.ed4e.unequipped",type:"system"},weaponAttack:{id:"weaponAttack",name:"tokenActionHud.ed4e.attack",type:"system"},threadItems:{id:"threadItems",name:"earthdawn.t.threadItems",type:"system"},optionsModifier:{id:"optionsModifier",name:"earthdawn.c.combatOptions",type:"system"},combatActions:{id:"combatActions",name:"earthdawn.a.actions",type:"system"},talents:{id:"talents",name:"earthdawn.t.talents",type:"system"},skills:{id:"skills",name:"earthdawn.s.skills",type:"system"},standard:{id:"standard",name:"earthdawn.s.standard",type:"system"},simple:{id:"simple",name:"earthdawn.s.sustained",type:"system"},free:{id:"free",name:"earthdawn.f.free",type:"system"},sustained:{id:"sustained",name:"earthdawn.s.sustained",type:"system"},na:{id:"na",name:"tokenActionHud.ed4e.na",type:"system"},token:{id:"token",name:"tokenActionHud.token",type:"system"},utility:{id:"utility",name:"tokenActionHud.utility",type:"system"},matrices:{id:"matrices",name:"tokenActionHud.ed4e.groupTitles.matrix",type:"system"},powers:{id:"powers",name:"earthdawn.p.powers",type:"system"},powerAttacks:{id:"powerAttacks",name:"earthdawn.a.attacks",type:"system"},powerManeuvers:{id:"powerManeuvers",name:"earthdawn.m.maneuvers",type:"system"},powerPowers:{id:"powerPowers",name:"earthdawn.p.powers",type:"system"},...d,...c};let g=null;Hooks.once("tokenActionHudCoreApiReady",(async t=>{g=class Utils{static getSetting(a,s=null){let i=s??null;try{i=game.settings.get(e.ID,a)}catch{t.api.Logger.debug(`Setting '${a}' not found`)}return i}static async setSetting(a,s){try{s=await game.settings.set(e.ID,a,s),t.api.Logger.debug(`Setting '${a}' set to '${s}'`)}catch{t.api.Logger.debug(`Setting '${a}' not found`)}}}}));let f=null;Hooks.once("tokenActionHudCoreApiReady",(async e=>{f=class ActionHandler extends e.api.ActionHandler{i18n=game.i18n;actors=null;tokens=null;actorType=null;items=null;abbreviateAttributes;showWeaponAmmoInfo;talentSkillGroupIds=null;spellGroupIds=null;inventoryGroupIds=null;powerGroupIds=null;async buildSystemActions(t){if(this.actors=this.actor?[this.actor]:this.#e(),this.tokens=this.token?[this.token]:this.#t(),this.actorType=this.actor?.type,this.actor){let t=this.actor.items;t=e.api.Utils.sortItemsByName(t),this.items=t}this.abbreviateAttributes=g.getSetting("abbreviateAttributes"),this.showWeaponAmmoInfo=g.getSetting("showWeaponAmmoInfo"),this.talentSkillGroupIds=["standard","simple","free","sustained","na"],this.spellGroupIds=Array.from({length:15},((e,t)=>`circle${t+1}spells`)),this.spellGroupIds.push(...Array.from(i,((e,t)=>`${e}Spells`))),this.powerGroupIds=["powerAttacks","powerManeuvers","powerPowers"],this.actor?("pc"!==this.actor.type&&"npc"!==this.actor.type||(this.inventoryGroupIds=["equipped","unequipped","threadItems","armors","equipment","shields","weapons"],await this.#a()),"creature"===this.actor.type&&await this.#s()):await this.#i()}async#a(){await Promise.all([this.#n(),this.#o("talent"),this.#o("skill"),this.#r(),this.#l(),this.#d(),this.#c()]),this.#m(),this.#p()}async#s(){await Promise.all([this.#h(),this.#c()]),this.#m(),this.#p()}async#i(){this.#m(),this.#p()}#m(){this.#u(),this.#y(),this.actor&&this.#w()}#w(){const e="creature"===this.actor?.type,t={"earthdawn.u.useKarma":"usekarma"};let a=["earthdawn.u.useKarma"].map((e=>({id:`action_system_${e}`,name:this.i18n.localize(e),encodedValue:["toggle",t[e]].join(this.delimiter),cssClass:"true"===this.actor.system.usekarma?"toggle active":"toggle"}))).filter((e=>!!e)).sort(((e,t)=>e.name.localeCompare(t.name)));const s={id:"system",type:"system"};e||this.addActions(a,s)}#y(){const e="creature"===this.actor?.type;let t=[{id:null,name:this.i18n.localize("earthdawn.r.recovery"),encodedValue:["recovery","recovery"].join(this.delimiter),info1:{text:this.actor?`${this.actor.system.recoverytestscurrent??0}/${this.actor.system.recoverytestsrefreshFinal??0}`:"",title:this.actor?this.i18n.localize("tokenActionHud.ed4e.infoTitles.recoveryTests"):""}}];e||t.push({id:"action_other_newDay",name:this.i18n.localize("earthdawn.n.newDay"),encodedValue:["newday","newday"].join(this.delimiter)},{id:"action_other_halfMagic",name:this.i18n.localize("earthdawn.h.halfMagic"),encodedValue:["halfmagic","halfmagic"].join(this.delimiter)});this.addActions(t,{id:"other",type:"system"})}#u(){let e=n.map((e=>({id:`action_attribute_${e}`,name:this.i18n.localize(this.abbreviateAttributes?r[e]:o[e]),encodedValue:["attribute",e].join(this.delimiter),tooltip:this.i18n.format("tokenActionHud.ed4e.tooltips.attributeTest",{attribute:this.i18n.localize(e)}),info1:{text:this.actor?`${this.actor.system[`${e}Step`]}`:"",title:this.actor?this.i18n.localize("tokenActionHud.ed4e.infoTitles.attributeStep"):""}})));this.addActions(e,{id:"attributes",type:"system"})}async#n(){if("creature"===this.actor.type)return;const e=Array.from(this.actor.items.values()).filter((e=>"true"===e.system.favorite));if(e.length<1)return;const t={id:"favorites",type:"system"};let a=await Promise.all(e.map((async e=>await this.#g(e.type,e,t))));a.sort(((e,t)=>e.name.localeCompare(t.name))),this.addActions(a,t)}async#o(t){const a=new Map;for(const[e,s]of this.items){s.type===t&&a.set(e,s)}if(0===a.size)return;e.api.Logger.debug(`Building group "${t}s"`);const s=new Map;for(const[e,t]of a){const a=t.system.action?.toLowerCase()??"na";s.has(a)||s.set(a,new Map),s.get(a).set(e,t)}const i={standard:this.i18n.localize("earthdawn.s.standard"),simple:this.i18n.localize("earthdawn.s.simple"),free:this.i18n.localize("earthdawn.s.free"),sustained:this.i18n.localize("earthdawn.s.sustained"),na:this.i18n.localize("tokenActionHud.ed4e.na")};for(const e of this.talentSkillGroupIds){if(!s.has(e))continue;const a={id:e,nestId:`${t}s_${e}`,name:i[e]??"",type:"system"},n=s.get(e);await this.#f(n,a,t)}const n=`${t}s`,o={id:n,nestId:[n,n].join("_"),type:"system"};await this.#f(a,o,t)}async#r(){const e=new Map;for(const[t,a]of this.items){if("spell"===a.type){const s=`circle${a.system.circle}spells`,i=`${a.system.discipline.toLowerCase()}Spells`;this.#k(e,s,t,a),this.#k(e,i,t,a)}}const t=[...Array(15).keys()].map((e=>e+1));let a={};for(const e of t)a[`circle${e}spells`]={spellCircle:e,name:`${this.i18n.localize("earthdawn.c.circle")} ${e}`};for(const e of i)a[`${e}Spells`]={discipline:e,name:e.charAt(0).toUpperCase()+e.slice(1)};for(const t of this.spellGroupIds){const s=a[t].name;if(!e.has(t))continue;const i={id:t,name:s,type:"system"},n=e.get(t);await this.#f(n,i,"spell")}}async#h(){if(this.items.size<1)return;const e=new Map;for(const[t,a]of this.items)if("attack"===a.type){switch(a.system.powerType.toLowerCase()){case"attack":this.#k(e,"powerAttacks",t,a);break;case"maneuver":this.#k(e,"powerManeuvers",t,a);break;case"power":this.#k(e,"powerPowers",t,a)}}const t={powerAttacks:this.i18n.localize("earthdawn.a.attacks"),powerManeuvers:this.i18n.localize("earthdawn.m.maneuvers"),powerPowers:this.i18n.localize("earthdawn.p.powers")};for(const a of this.powerGroupIds){if(!e.has(a))continue;const s={id:a,name:t[a],type:"system"},i=e.get(a);await this.#f(i,s,"power")}}async#d(){if(this.items.size<1)return;const e=new Map;for(const[t,a]of this.items){const s=a.system.hasOwnProperty("worn"),i=a.system.isthread,n=!!a.system.worn;a.system?.amount;const o=a.type;n?this.#k(e,"equipped",t,a):s&&this.#k(e,"unequipped",t,a),i&&this.#k(e,"threadItems",t,a),"armor"===o&&this.#k(e,"armors",t,a),"equipment"===o&&this.#k(e,"equipment",t,a),"shield"===o&&this.#k(e,"shields",t,a),"weapon"===o&&this.#k(e,"weapons",t,a)}const t={equipped:this.i18n.localize("earthdawn.e.equipped"),unequipped:this.i18n.localize("tokenActionHud.ed4e.unequipped"),threadItems:this.i18n.localize("earthdawn.t.threadItems"),armors:this.i18n.localize("earthdawn.a.armors"),equipment:this.i18n.localize("earthdawn.e.equipment"),shields:this.i18n.localize("earthdawn.s.shields"),weapons:this.i18n.localize("earthdawn.w.weapons")};for(const a of this.inventoryGroupIds){if(!e.has(a))continue;const s={id:a,name:t[a],type:"system"},i=e.get(a);await this.#f(i,s)}}async#f(e,t,a="item"){if(0===e.size)return;if(!("string"==typeof t?t:t?.id))return;const s=await Promise.all([...e].map((async e=>await this.#g(a,e[1],t))));this.addActions(s,t)}async#g(t,a,i){const n=a.id??a._id;let o=a?.name??a?.label;const r=`${`${e.api.Utils.i18n(s[t])}: `??""}${o}`;r||e.api.Logger.debug("No list name for: ",{actionType:t,entity:a,groupData:i});let l="";if(Object.hasOwn(a,"disabled")){l=`toggle${a.disabled?"":" active"}`}const d=[t,n].join(this.delimiter),c=e.api.Utils.getImage(a),m=this.#b(a),p=m.icon1,h=m.icon2,u=m.icon3,y=this.#A(a,i),w=y?.info1,g=y?.info2,f=y?.info3;return{id:n,name:o,encodedValue:d,cssClass:l,img:c,icon1:p,icon2:h,icon3:u,info1:w,info2:g,info3:f,listName:r}}#A(e,t){let a,s,i;switch(e.type){case"talent":case"skill":a={text:`${e.system.finalranks??e.system.ranks}`,title:this.i18n.localize("earthdawn.r.rank")},s={text:this.i18n.localize(r[e.system.attribute.replace("Step","")]??"earthdawn.n.none"),title:this.i18n.localize("earthdawn.a.attribute")},e.system.strain>0&&(i={text:e.system.strain.toString(),title:this.i18n.localize("earthdawn.s.strain"),class:"tah-spotlight"});break;case"attack":"Maneuver"!==e.system.powerType&&(e.system.attackstep>0||e.system.damagestep>0)&&(a={text:`${e.system.attackstep}`,title:this.i18n.localize("earthdawn.r.rollStep")},s={text:`${e.system.damagestep}`,title:this.i18n.localize("earthdawn.d.damageStep")}),e.system.strain>0&&(i={text:e.system.strain.toString(),title:this.i18n.localize("earthdawn.s.strain"),class:"tah-spotlight"});break;case"spell":a={text:`${e.system.threadsrequired}`,title:this.i18n.localize("earthdawn.s.spellThreads")},s=t.id.includes("circle")?{text:e.system.discipline??this.i18n.localize("tokenActionHud.ed4e.na"),title:this.i18n.localize("earthdawn.d.discipline")}:{text:`${e.system.circle}`,title:this.i18n.localize("earthdawn.c.circle")},i=null;break;case"equipment":e.system.amount>1&&(a={text:`${e.system.amount}x`,title:this.i18n.localize("earthdawn.a.amount")});break;case"armor":a={text:`${e.system.physicalArmorFinal} ${this.i18n.localize("tokenActionHud.ed4e.abbreviations.physicalArmor")}`,title:this.i18n.localize("earthdawn.p.physicalArmor")},s={text:`${e.system.mysticArmorFinal} ${this.i18n.localize("tokenActionHud.ed4e.abbreviations.mysticArmor")}`,title:this.i18n.localize("earthdawn.m.mysticArmor")};break;case"shield":a={text:`${e.system.physicaldefense} ${this.i18n.localize("tokenActionHud.ed4e.abbreviations.physicalDefense")}`,title:this.i18n.localize("earthdawn.p.physicalDefense")},s={text:`${e.system.mysticdefense} ${this.i18n.localize("tokenActionHud.ed4e.abbreviations.mysticDefense")}`,title:this.i18n.localize("earthdawn.m.mysticDefense")},i={text:`${e.system.shatterthreshold}`,title:this.i18n.localize("earthdawn.s.shatterThreshold")};break;case"weapon":a={text:`${e.system.damageTotal}`,title:this.i18n.localize("tokenActionHud.ed4e.tooltips.info.weaponStepTotal")},["ranged","thrown"].includes(e.system.weapontype)&&(s={text:`${e.system.shortrange}/${e.system.longrange}`,title:this.i18n.localize("tokenActionHud.ed4e.tooltips.info.weaponRange")},i={text:`${e.system.ammo}`,title:this.i18n.localize("tokenActionHud.ed4e.tooltips.info.weaponAmmo")})}return{info1:a,info2:s,info3:i}}#b(e){let t,a,s;switch(e.type){case"talent":case"skill":case"attack":e.system.strain>0&&(t=`<i class="fa-thin fa-droplet" title="${this.i18n.localize("earthdawn.s.strain")}"></i>`);break;case"weapon":t=`<i class="${m[e.system.weapontype.toLowerCase()]}" title="${this.i18n.localize("earthdawn.w.weaponType")}"></i>`;case"armor":(e.system.timesForged>0||e.system.timesForgedMystic>0||e.system.timesForgedPhysical>0)&&(a=`<i class="fa-thin fa-hammer-crash" title="${this.i18n.localize("tokenActionHud.ed4e.forged")}"></i>`)}return e.system.isthread&&(s=`<i class="fa-thin fa-wand-sparkles" title="${this.i18n.localize("earthdawn.t.threadItem")}"></i>`),{icon1:t,icon2:a,icon3:s}}#e(){const e=["pc","npc","creature"],t=canvas.tokens.controlled.filter((e=>e.actor)).map((e=>e.actor));return t.every((t=>e.includes(t.type)))?t:[]}#t(){const e=["pc","npc","creature"],t=canvas.tokens.controlled;return t.filter((e=>e.actor)).map((e=>e.actor)).every((t=>e.includes(t.type)))?t:[]}#k(e,t,a,s){e.has(t)||e.set(t,new Map),e.get(t).set(a,s)}#v(e){}#I(e){}#p(){const t="utility",a={initiative:{id:"initiative",name:e.api.Utils.i18n("tokenActionHud.ed4e.rollInitiative")},endTurn:{id:"endTurn",name:e.api.Utils.i18n("tokenActionHud.endTurn")}};game.combat?.current?.tokenId!==this.token?.id&&delete a.endTurn;const i=Object.entries(a).map((a=>{const i=a[1].id,n=a[1].name,o=`${`${e.api.Utils.i18n(s[t])}: `??""}${n}`,r=[t,i].join(this.delimiter),l={};let d="";if("initiative"===a[0]&&game.combat){const e=canvas.tokens.controlled.map((e=>e.id)),t=game.combat.combatants.filter((t=>e.includes(t.tokenId)));if(1===t.length){const e=t[0].initiative;l.class="tah-spotlight",l.text=e}d=`toggle${t.length>0&&t.every((e=>e?.initiative))?" active":""}`}return{id:i,name:n,encodedValue:r,info1:l,cssClass:d,listName:o}}));this.addActions(i,{id:"combatUtilities",type:"system"})}async#c(){const e={id:"weaponAttack",name:this.i18n.localize("tokenActionHud.ed4e.attack"),type:"system"},t=this.actor.items.filter((e=>"weapon"===e.type&&e.system.worn)),a=await Promise.all(t.map((async t=>await this.#g("weaponAttack",t,e))));this.addActions(a,e);const s={"earthdawn.c.combatOptionsAggressive":"tactics.aggressive","earthdawn.c.combatOptionsDefensive":"tactics.defensive","earthdawn.c.combatModifierHarried":"tactics.harried","earthdawn.c.combatModifierKnockedDown":"tactics.knockeddown"};let i=["earthdawn.c.combatOptionsAggressive","earthdawn.c.combatOptionsDefensive","earthdawn.c.combatModifierHarried","earthdawn.c.combatModifierKnockedDown"].map((e=>({id:`combatTactic_${e}`,name:this.i18n.localize(e),encodedValue:["toggle",s[e]].join(this.delimiter),cssClass:!0===this.actor.system.tactics[s[e].split(".")[1]]?"toggle active":"toggle"}))).sort(((e,t)=>e.name.localeCompare(t.name)));this.addActions(i,{id:"optionsModifier",name:"earthdawn.c.combatOptions",type:"system"});const n={id:"combatActions",name:this.i18n.localize("earthdawn.a.actions"),type:"system"},o=[{id:"combatAction_takeDamage",name:this.i18n.localize("earthdawn.t.takeDamage"),encodedValue:["takedamage","takedamage"].join(this.delimiter)},{id:"combatAction_knockdownTest",name:this.i18n.localize("earthdawn.c.combatOptionsKnockdownTest"),encodedValue:["knockdowntest","knockdowntest"].join(this.delimiter)},{id:"combatAction_jumpUp",name:this.i18n.localize("earthdawn.c.combatOptionsJumpUp"),encodedValue:["jumpup","jumpup"].join(this.delimiter)}];this.addActions(o,n)}async#l(){const e=this.actor.items.filter((e=>"spellmatrix"===e.type));if(e.length<1)return;const t={id:"matrices"};for(const a of e){const e={id:`matrix_${a.id}`,name:a.name,type:"system-derived",selected:!0,info1:{text:a.system.currentspell,info:this.i18n.localize("tokenActionHud.ed4e.tooltips.info.matrixSpell"),class:"tah-spotlight"},info2:{text:`${a.system.totalthreads}/${a.system.totalthreadsneeded}`,title:this.i18n.localize("tokenActionHud.ed4e.tooltips.info.matrixThreads")}},s={matrixAttune:"earthdawn.a.attune",matrixWeave:"earthdawn.m.matrixWeaveRed",matrixCast:"earthdawn.m.matrixCastRed",matrixClear:"earthdawn.m.matrixClearRed"},i=Array.from(Object.entries(s),(([e,t])=>({id:a.id,name:this.i18n.localize(t),encodedValue:[e,a.id].join(this.delimiter),selected:!0})));await this.addGroup(e,t,!0),this.addActions(i,e)}}}}));let k=null;Hooks.once("tokenActionHudCoreApiReady",(async e=>{const t=w;Object.values(t).forEach((t=>{t.name=e.api.Utils.i18n(t.name),t.listName=`Group: ${e.api.Utils.i18n(t.name)}`}));const a=Object.values(t);k={layout:[{nestId:"general",id:"general",name:e.api.Utils.i18n("tokenActionHud.ed4e.groupTitles.general"),groups:[{...t.attributes,nestId:"general_attributes"},{...t.other,nestId:"general_other"},{...t.system,nestId:"general_system"}]},{nestId:"powers",id:"powers",name:e.api.Utils.i18n("earthdawn.p.powers"),groups:[{...t.powerAttacks,nestId:"powers_powerAttacks"},{...t.powerManeuvers,nestId:"powers_powerManeuvers"},{...t.powerPowers,nestId:"powers_powerPowers"}]},{nestId:"favorites",id:"favorites",name:e.api.Utils.i18n("tokenActionHud.ed4e.groupTitles.favorites"),groups:[{...t.favorites,nestId:"favorites_favorites"}]},{nestId:"talents",id:"talents",name:e.api.Utils.i18n("earthdawn.t.talents"),type:"system",groups:[{...t.standard,nestId:"talents_standard"},{...t.simple,nestId:"talents_simple"},{...t.free,nestId:"talents_free"},{...t.sustained,nestId:"talents_sustained"},{...t.na,nestId:"talents_na"}]},{nestId:"skills",id:"skills",name:e.api.Utils.i18n("earthdawn.s.skills"),groups:[{...t.standard,nestId:"skills_standard"},{...t.simple,nestId:"skills_simple"},{...t.free,nestId:"skills_free"},{...t.sustained,nestId:"skills_sustained"},{...t.na,nestId:"skills_na"}]},{nestId:"spells",id:"spells",name:e.api.Utils.i18n("earthdawn.s.spells"),groups:Array.from(Object.values(d),(e=>(e.nestId=`spells_${e.id}`,e)))},{nestId:"inventory",id:"inventory",name:e.api.Utils.i18n("earthdawn.i.inventory"),groups:[{...t.weapons,nestId:"inventory_weapons"},{...t.armors,nestId:"inventory_armors"},{...t.shields,nestId:"inventory_shields"},{...t.equipment,nestId:"inventory_equipment"}]},{nestId:"matrices",id:"matrices",name:e.api.Utils.i18n("tokenActionHud.ed4e.groupTitles.matrix")},{nestId:"combat",id:"combat",name:e.api.Utils.i18n("earthdawn.c.combat"),groups:[{...t.weaponAttack,nestId:"combat_weaponAttack"},{...t.optionsModifier,nestId:"combat_optionsModifier"},{...t.combatActions,nestId:"combat_actions"}]},{nestId:"effects",id:"effects",name:"TODO",groups:[]},{nestId:"utility",id:"utility",name:e.api.Utils.i18n("tokenActionHud.utility"),groups:[{...t.combatUtilities,nestId:"utility_combatUtilities"},{...t.token,nestId:"utility_token"}]}],groups:a}}));let b=null;function register(t){game.settings.register(e.ID,"abbreviateAttributes",{name:game.i18n.localize("tokenActionHud.ed4e.settings.abbreviateAttributes.name"),hint:game.i18n.localize("tokenActionHud.ed4e.settings.abbreviateAttributes.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{t(e)}}),game.settings.register(e.ID,"showWeaponAmmoInfo",{name:game.i18n.localize("tokenActionHud.ed4e.settings.showWeaponAmmoInfo.name"),hint:game.i18n.localize("tokenActionHud.ed4e.settings.showWeaponAmmoInfo.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{t(e)}})}Hooks.once("tokenActionHudCoreApiReady",(async e=>{b=class RollHandler extends e.api.RollHandler{async doHandleActionEvent(e,t){let a=t.split("|");3!==a.length&&super.throwInvalidValueErr();let s=a[0],i=a[1],n=a[2];if("multi"===i)for(let t of canvas.tokens.controlled){let a=t.id;await this._handleMacros(e,s,a,n)}else await this._handleMacros(e,s,i,n)}async _handleMacros(e,t,a,s){let i=super.getActor(a);switch(t){case"skill":case"talent":this.rollTalentMacro(e,a,s);break;case"attack":case"power":case"maneuver":this.handleCreatureActionMacro(e,a,s);break;case"inventory":this.rollInventoryMacro(e,a,s);break;case"toggle":this.toggleDataProperty(e,a,s);break;case"attribute":this.rollAttributeMacro(e,a,s);break;case"recovery":i.recoveryTest();break;case"newday":i.newDay();break;case"halfmagic":i.halfMagic();break;case"matrixAttune":i.attuneMatrix(i.items.get(s));break;case"matrixWeave":i.weaveThread(i.items.get(s));break;case"matrixCast":i.castSpell(i.items.get(s));break;case"matrixClear":i.clearMatrix(i.items.get(s));break;case"weaponAttack":i.rollPrep({weaponID:s,rolltype:"attack"});break;case"takedamage":this.takeDamage(i);break;case"knockdowntest":i.knockdownTest({});break;case"jumpup":i.jumpUpTest()}}rollAttributeMacro(e,t,a){super.getActor(t).rollPrep({attribute:`${a.split(".").slice(-1)}Step`,name:a})}rollTalentMacro(e,t,a){super.getActor(t).rollPrep({talentID:a})}rollInventoryMacro(e,t,a){const s=super.getActor(t).items.get(a);"equipment"===s.type?s.sheet.render(!0):["weapon","armor","shield"].indexOf(s.type)>=0?this.toggleItemWornProperty(e,t,a):Logger.error(s.type," is not a valid actionId for rolling an inventory item")}toggleDataProperty(e,t,a){const s=super.getActor(t);if(a.includes("tactics")){const e=a.split(".")[1];s.update({data:{tactics:{[e]:!s.system.tactics[e]}}})}else{const e=s.data[a];let t="string"===typeof e?this._toggleBooleanString(e):!e;s.update({data:{[a]:t}})}}toggleItemWornProperty(e,t,a){const s=super.getActor(t).items.get(a),i=s.system.worn;let n="string"===typeof i?this._toggleBooleanString(i):!i;s.update({data:{worn:n}})}_toggleBooleanString(e){return e.toLowerCase().includes("true")?"false":e.toLowerCase().includes("false")?"true":"false"}handleCreatureActionMacro(e,t,a){const s=super.getActor(t),i=s.items.get(a);if(0!==i.system.attackstep){const e=0,t=i.system.strain?i.system.strain:0,n=0;let o="Attack"===i.system.powerType?"attack":i.system.attackstep>0?"test":"";const r={itemID:a,steps:i.system.attackstep,talent:i.name,strain:t,type:o,karma:n,modifier:e};s.NPCtest(r)}else s.items.get(a).sheet.render(!0)}async takeDamage(e){let t=await new Promise((e=>{new Dialog({title:this.i18n("earthdawn.t.takeDamage"),content:`\n          <div style="float: left">\n              <label>${this.i18n("earthdawn.d.damage")}: </label>\n              <input id="damage_box" value=0 autofocus/>\n          </div>\n          <div>\n              <label>${this.i18n("earthdawn.t.type")}: </label>\n              <select id="type_box">\n                <option value="physical">Physical</option>\n                <option value="mystic">Mystic</option>\n              </select>\n          </div>\n          <div>\n            <label>${this.i18n("earthdawn.i.ignoreArmor")}?</label>\n            <input type="checkbox" id="ignore_box"/>\n          </div>`,buttons:{ok:{label:this.i18n("earthdawn.o.ok"),callback:t=>{e({damage:t.find("#damage_box").val(),type:t.find("#type_box").val(),ignore:t.find("#ignore_box:checked")})}}},default:"ok"}).render(!0)}));t.ignorearmor=t.ignore.length>0,await e.takeDamage(t)}}}));let A=null;Hooks.once("tokenActionHudCoreApiReady",(async e=>{A=class SystemManager extends e.api.SystemManager{doGetCategoryManager(t){return new e.api.CategoryManager}doGetActionHandler(e){return new f(e)}getAvailableRollHandlers(){return{core:"Core Earthdawn 4th Edition"}}doGetRollHandler(e){let t;return t=new b,t}doRegisterSettings(e){register(e)}async doRegisterDefaultFlags(){return k}}})),Hooks.on("tokenActionHudCoreApiReady",(async()=>{const t=game.modules.get(e.ID);t.api={requiredCoreModuleVersion:"1.4",SystemManager:A},Hooks.call("tokenActionHudSystemReady",t)}));export{s as ACTION_TYPE,n as ATTRIBUTES,r as ATTRIBUTES_ABBREVIATED,o as ATTRIBUTES_FULL_NAME,f as ActionHandler,p as CONCENTRATION_ICON,t as CORE_MODULE,k as DEFAULTS,w as GROUP,l as MAX_SPELL_CIRCLE,e as MODULE,h as PREPARED_ICON,y as PROFICIENCY_LEVEL_ICON,a as REQUIRED_CORE_MODULE_VERSION,u as RITUAL_ICON,b as RollHandler,i as SPELLCASTING_DISCIPLINES,A as SystemManager,g as Utils,m as WEAPON_TYPE_ICON,d as circleGroupData,c as disciplineGroupData,register};
//# sourceMappingURL=token-action-hud-ed4e.min.js.map

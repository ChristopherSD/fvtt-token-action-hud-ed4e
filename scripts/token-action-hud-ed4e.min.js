const e={ID:"token-action-hud-ed4e"},t={ID:"token-action-hud-core"},a="1.4",s={talent:"earthdawn.t.talent",skill:"earthdawn.s.skill",spell:"earthdawn.s.spell",matrix:"earthdawn.m.matrix",item:"tokenActionHud.ed4e.item"},n=["dexterity","strength","toughness","perception","willpower","charisma"],i={dexterity:"earthdawn.d.dexterity",strength:"earthdawn.s.strength",toughness:"earthdawn.t.toughness",perception:"earthdawn.p.perception",willpower:"earthdawn.w.willpower",charisma:"earthdawn.c.charisma"},o={dexterity:"earthdawn.d.DEX",strength:"earthdawn.s.STR",toughness:"earthdawn.t.TOU",perception:"earthdawn.p.PER",willpower:"earthdawn.w.WIL",charisma:"earthdawn.c.CHA",initiative:"earthdawn.i.INI"},r={bonus:"fas fa-plus",crew:"fas fa-users",day:"fas fa-hourglass-end",hour:"fas fa-hourglass-half",lair:"fas fa-home",minute:"fas fa-hourglass-start",legendary:"fas fas fa-dragon",reaction:"fas fa-bolt",special:"fas fa-star"},l="fas fa-circle-c",d="fas fa-sun",c="fas fa-circle-r",u={.5:"fas fa-adjust",1:"fas fa-check",2:"fas fa-check-double"},p={attributes:{id:"attributes",name:"earthdawn.a.attributes",type:"system"},other:{id:"other",name:"earthdawn.o.other",type:"system"},system:{id:"system",name:"tokenActionHud.ed4e.system",type:"system"},favorites:{id:"favorites",name:"tokenActionHud.ed4e.favorites",type:"system"},weapons:{id:"weapons",name:"earthdawn.w.weapons",type:"system"},armors:{id:"armors",name:"earthdawn.a.armors",type:"system"},shields:{id:"shields",name:"earthdawn.s.shields",type:"system"},equipment:{id:"equipment",name:"earthdawn.e.equipment",type:"system"},weaponAttack:{id:"weaponAttack",name:"tokenActionHud.ed4e.attack",type:"system"},optionsModifier:{id:"optionsModifier",name:"tokenActionHud.ed4e.options",type:"system"},actions:{id:"actions",name:"earthdawn.a.actions",type:"system"},talents:{id:"talents",name:"earthdawn.t.talents",type:"system"},skills:{id:"skills",name:"earthdawn.s.skills",type:"system"},standard:{id:"standard",name:"earthdawn.s.standard",type:"system"},simple:{id:"simple",name:"earthdawn.s.sustained",type:"system"},free:{id:"free",name:"earthdawn.f.free",type:"system"},sustained:{id:"sustained",name:"earthdawn.s.sustained",type:"system"},na:{id:"na",name:"tokenActionHud.ed4e.na",type:"system"}};let m=null;Hooks.once("tokenActionHudCoreApiReady",(async t=>{m=class Utils{static getSetting(a,s=null){let n=s??null;try{n=game.settings.get(e.ID,a)}catch{t.api.Logger.debug(`Setting '${a}' not found`)}return n}static async setSetting(a,s){try{s=await game.settings.set(e.ID,a,s),t.api.Logger.debug(`Setting '${a}' set to '${s}'`)}catch{t.api.Logger.debug(`Setting '${a}' not found`)}}}}));let h=null;Hooks.once("tokenActionHudCoreApiReady",(async e=>{h=class ActionHandler extends e.api.ActionHandler{i18n=game.i18n;actors=null;tokens=null;actorType=null;items=null;abbreviateAttributes;groupTalents;groupSkills;talentSkillGroupIds=null;async buildSystemActions(t){if(this.actors=this.actor?[this.actor]:this.#e(),this.tokens=this.token?[this.token]:this.#t(),this.actorType=this.actor?.type,this.actor){let t=this.actor.items;t=e.api.Utils.sortItemsByName(t),this.items=t}this.abbreviateAttributes=m.getSetting("abbreviateAttributes"),this.groupTalents=m.getSetting("groupTalentsByActionType"),this.groupSkills=m.getSetting("groupSkillsByActionType"),this.talentSkillGroupIds=["standard","simple","free","sustained","na"],this.actor&&(["pc","npc"].includes(this.actor.type)&&await this.#a(),"creature"===this.actor.type&&await this.#s())}async#a(){await Promise.all([this.#n("talent"),this.#n("skill")]),this.#i(),this.#o()}async#s(){this.#i()}#i(){const e="creature"===this.actor.type;let t=n.map((e=>({id:null,name:this.i18n.localize(this.abbreviateAttributes?o[e]:i[e]),encodedValue:["attribute",this.token.id,e].join(this.delimiter),tooltip:this.i18n.format("tokenActionHud.ed4e.tooltips.attributeTest",{attribute:this.i18n.localize(e)}),info1:{text:`${this.actor.system[`${e}Step`]}`,title:this.i18n.localize("tokenActionHud.ed4e.infoTitles.attributeStep")}}))).filter((e=>!!e));this.addActions(t,{id:"attributes",type:"system"});let a=[{id:null,name:this.i18n.localize("earthdawn.r.recovery"),encodedValue:["recovery",this.token.id,"recovery"].join(this.delimiter),info1:{text:`${this.actor.system.recoverytestscurrent}/${this.actor.system.recoverytestsrefreshFinal}`}}];e||a.push({id:null,name:this.i18n.localize("earthdawn.n.newDay"),encodedValue:["newday",this.token.id,"newday"].join(this.delimiter)},{id:null,name:this.i18n.localize("earthdawn.h.halfMagic"),encodedValue:["halfmagic",this.token.id,"halfmagic"].join(this.delimiter)});this.addActions(a,{id:"other",type:"system"});const s={"earthdawn.u.useKarma":"usekarma"};let r=["earthdawn.u.useKarma"].map((e=>({id:null,name:this.i18n.localize(e),encodedValue:["toggle",this.token.id,s[e]].join(this.delimiter),cssClass:"true"===this.actor.system.usekarma?"toggle active":"toggle"}))).filter((e=>!!e)).sort(((e,t)=>e.name.localeCompare(t.name)));const l={id:"system",type:"system"};e||this.addActions(r,l)}#o(){if("creature"===this.actor.type)return;let e=Array.from(this.actor.items.values()).filter((e=>"true"===e.system.favorite)).map((e=>{try{const t=e.id,a=e.type.toLowerCase(),s=e.name;let n=e.system.hasOwnProperty("ranks")?`${e.system.ranks}`:null,i=[a,this.token.id,t].join(this.delimiter);return{id:t,name:s,encodedValue:i,info1:{text:n}}}catch(t){return t(e??"No item in favorites"),null}})).filter((e=>!!e)).sort(((e,t)=>e.name.localeCompare(t.name)));this.addActions(e,{id:"favorites",type:"system"})}async#n(t){const a=new Map;for(const[e,s]of this.items){s.type===t&&a.set(e,s)}if(0!==a.size)if(e.api.Logger.debug(`Building category, type: ${t}`),console.debug(`Building category, type: ${t}`),"talent"===t&&this.groupTalents||"skill"===t&&this.groupSkills){const e=new Map;for(const[t,s]of a){const a=s.system.action?.toLowerCase()??"na";e.has(a)||e.set(a,new Map),e.get(a).set(t,s)}const s={standard:this.i18n.localize("earthdawn.s.standard"),simple:this.i18n.localize("earthdawn.s.simple"),free:this.i18n.localize("earthdawn.s.free"),sustained:this.i18n.localize("earthdawn.s.sustained"),na:this.i18n.localize("tokenActionHud.ed4e.na")};for(const a of this.talentSkillGroupIds){if(!e.has(a))continue;const n={id:a,nestId:`${t}s_${a}`,name:s[a]??"",type:"system"},i=e.get(a);await this.#r(i,n,t)}}else{const e=`${t}s`,s={id:e,nestId:[e,e].join("_"),type:"system"};await this.#r(a,s,t)}}async#r(e,t,a="item"){if(0===e.size)return;if(!("string"==typeof t?t:t?.id))return;const s=await Promise.all([...e].map((async e=>await this.#l(a,e[1]))));this.addActions(s,t)}async#l(t,a){const n=a.id??a._id;let i=a?.name??a?.label;const o=`${`${e.api.Utils.i18n(s[t])}: `??""}${i}`;let r="";if(Object.hasOwn(a,"disabled")){r=`toggle${a.disabled?"":" active"}`}const l=[t,this.token.id,n].join(this.delimiter),d=e.api.Utils.getImage(a);let c=null;"spell"===a.type||(c=this.#d(a));const u=c?.info1,p=c?.info2,m=c?.info3;return{id:n,name:i,encodedValue:l,cssClass:r,img:d,info1:u,info2:p,info3:m,listName:o}}#d(e){let t,a,s;switch(e.type){case"talent":case"skill":t={text:`${e.system.finalranks??e.system.ranks}`,title:this.i18n.localize("earthdawn.r.rank")},a={text:this.i18n.localize(o[e.system.attribute.replace("Step","")]??"earthdawn.n.none"),title:this.i18n.localize("earthdawn.a.attribute")},s={text:e.system.strain?.toString()??"0",title:this.i18n.localize("earthdawn.s.strain")}}return{info1:t,info2:a,info3:s}}#e(){const e=["pc","npc","creature"],t=canvas.tokens.controlled.filter((e=>e.actor)).map((e=>e.actor));return t.every((t=>e.includes(t.type)))?t:[]}#t(){const e=["pc","npc","creature"],t=canvas.tokens.controlled;return t.filter((e=>e.actor)).map((e=>e.actor)).every((t=>e.includes(t.type)))?t:[]}#c(e){}#u(e){}}}));let g=null;Hooks.once("tokenActionHudCoreApiReady",(async e=>{const t=p;Object.values(t).forEach((t=>{t.name=e.api.Utils.i18n(t.name),t.listName=`Group: ${e.api.Utils.i18n(t.name)}`}));const a=Object.values(t);g={layout:[{nestId:"general",id:"general",name:e.api.Utils.i18n("tokenActionHud.ed4e.general"),groups:[{...t.attributes,nestId:"general_attributes"},{...t.other,nestId:"general_other"},{...t.system,nestId:"general_system"}]},{nestId:"favorites",id:"favorites",name:e.api.Utils.i18n("tokenActionHud.ed4e.favorites"),groups:[{...t.favorites,nestId:"favorites_favorites"}]},{nestId:"talents",id:"talents",name:e.api.Utils.i18n("earthdawn.t.talents"),type:"system",groups:[{...t.standard,nestId:"talents_standard"},{...t.simple,nestId:"talents_simple"},{...t.free,nestId:"talents_free"},{...t.sustained,nestId:"talents_sustained"},{...t.na,nestId:"talents_na"},{...t.talents,nestId:"talents_talents"}]},{nestId:"skills",id:"skills",name:e.api.Utils.i18n("earthdawn.s.skills"),groups:[{...t.standard,nestId:"skills_standard"},{...t.simple,nestId:"skills_simple"},{...t.free,nestId:"skills_free"},{...t.sustained,nestId:"skills_sustained"},{...t.na,nestId:"skills_na"},{...t.skills,nestId:"skills_skills"}]},{nestId:"spells",id:"spells",name:"TODO",groups:[]},{nestId:"inventory",id:"inventory",name:e.api.Utils.i18n("earthdawn.i.inventory"),groups:[{...t.weapons,nestId:"inventory_weapons"},{...t.armors,nestId:"inventory_armors"},{...t.shields,nestId:"inventory_shields"},{...t.equipment,nestId:"inventory_equipment"}]},{nestId:"combat",id:"combat",name:e.api.Utils.i18n("earthdawn.c.combat"),groups:[{...t.weaponAttack,nestId:"combat_weaponAttack"},{...t.optionsModifier,nestId:"combate_optionsModifier"},{...t.actions,nestId:"combat_actions"}]},{nestId:"effects",id:"effects",name:"TODO",groups:[]}],groups:a}}));let y=null;function register(t){game.settings.register(e.ID,"abbreviateAttributes",{name:game.i18n.localize("tokenActionHud.ed4e.settings.abbreviateAttributes.name"),hint:game.i18n.localize("tokenActionHud.ed4e.settings.abbreviateAttributes.hint"),scope:"client",config:!0,type:Boolean,default:!1,onChange:e=>{t(e)}}),game.settings.register(e.ID,"groupTalentsByActionType",{name:game.i18n.localize("tokenActionHud.ed4e.settings.groupTalentsByActionType.name"),hint:game.i18n.localize("tokenActionHud.ed4e.settings.groupTalentsByActionType.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{t(e)}}),game.settings.register(e.ID,"groupSkillsByActionType",{name:game.i18n.localize("tokenActionHud.ed4e.settings.groupSkillsByActionType.name"),hint:game.i18n.localize("tokenActionHud.ed4e.settings.groupSkillsByActionType.hint"),scope:"client",config:!0,type:Boolean,default:!0,onChange:e=>{t(e)}})}Hooks.once("tokenActionHudCoreApiReady",(async e=>{y=class RollHandler extends e.api.RollHandler{async doHandleActionEvent(e,t){let a=t.split("|");3!==a.length&&super.throwInvalidValueErr();let s=a[0],n=a[1],i=a[2];if("multi"===n)for(let t of canvas.tokens.controlled){let a=t.id;await this._handleMacros(e,s,a,i)}else await this._handleMacros(e,s,n,i)}async _handleMacros(e,t,a,s){let n=super.getActor(a);switch(t){case"skill":case"talent":this.rollTalentMacro(e,a,s);break;case"attack":case"power":case"maneuver":this.handleCreatureActionMacro(e,a,s);break;case"inventory":this.rollInventoryMacro(e,a,s);break;case"toggle":this.toggleDataProperty(e,a,s);break;case"attribute":this.rollAttributeMacro(e,a,s);break;case"recovery":n.recoveryTest();break;case"newday":n.newDay();break;case"halfmagic":n.halfMagic();break;case"matrixAttune":n.attuneMatrix(n.items.get(s));break;case"matrixWeave":n.weaveThread(n.items.get(s));break;case"matrixCast":n.castSpell(n.items.get(s));break;case"matrixClear":n.clearMatrix(n.items.get(s));break;case"weaponAttack":n.rollPrep({weaponID:s,rolltype:"attack"});break;case"takedamage":this.takeDamage(n);break;case"knockdowntest":n.knockdownTest({});break;case"jumpup":n.jumpUpTest()}}rollAttributeMacro(e,t,a){super.getActor(t).rollPrep({attribute:`${a.split(".").slice(-1)}Step`,name:a})}rollTalentMacro(e,t,a){super.getActor(t).rollPrep({talentID:a})}rollInventoryMacro(e,t,a){const s=super.getActor(t).items.get(a);"equipment"===s.type?s.sheet.render(!0):["weapon","armor","shield"].indexOf(s.type)>=0?this.toggleItemWornProperty(e,t,a):Logger.error(s.type," is not a valid actionId for rolling an inventory item")}toggleDataProperty(e,t,a){const s=super.getActor(t);if(a.includes("tactics")){const e=a.split(".")[1];s.update({data:{tactics:{[e]:!s.system.tactics[e]}}})}else{const e=s.data[a];let t="string"===typeof e?this._toggleBooleanString(e):!e;s.update({data:{[a]:t}})}}toggleItemWornProperty(e,t,a){const s=super.getActor(t).items.get(a),n=s.system.worn;let i="string"===typeof n?this._toggleBooleanString(n):!n;s.update({data:{worn:i}})}_toggleBooleanString(e){return e.toLowerCase().includes("true")?"false":e.toLowerCase().includes("false")?"true":"false"}handleCreatureActionMacro(e,t,a){const s=super.getActor(t),n=s.items.get(a);if(0!==n.system.attackstep){const e=0,t=n.system.strain?n.system.strain:0,i=0;let o="Attack"===n.system.powerType?"attack":n.system.attackstep>0?"test":"";const r={itemID:a,steps:n.system.attackstep,talent:n.name,strain:t,type:o,karma:i,modifier:e};s.NPCtest(r)}else s.items.get(a).sheet.render(!0)}async takeDamage(e){let t=await new Promise((e=>{new Dialog({title:this.i18n("earthdawn.t.takeDamage"),content:`\n          <div style="float: left">\n              <label>${this.i18n("earthdawn.d.damage")}: </label>\n              <input id="damage_box" value=0 autofocus/>\n          </div>\n          <div>\n              <label>${this.i18n("earthdawn.t.type")}: </label>\n              <select id="type_box">\n                <option value="physical">Physical</option>\n                <option value="mystic">Mystic</option>\n              </select>\n          </div>\n          <div>\n            <label>${this.i18n("earthdawn.i.ignoreArmor")}?</label>\n            <input type="checkbox" id="ignore_box"/>\n          </div>`,buttons:{ok:{label:this.i18n("earthdawn.o.ok"),callback:t=>{e({damage:t.find("#damage_box").val(),type:t.find("#type_box").val(),ignore:t.find("#ignore_box:checked")})}}},default:"ok"}).render(!0)}));t.ignorearmor=t.ignore.length>0,await e.takeDamage(t)}}}));let f=null;Hooks.once("tokenActionHudCoreApiReady",(async e=>{f=class SystemManager extends e.api.SystemManager{doGetCategoryManager(t){return new e.api.CategoryManager}doGetActionHandler(e){return new h(e)}getAvailableRollHandlers(){return{core:"Core Earthdawn 4th Edition"}}doGetRollHandler(e){let t;return t=new y,t}doRegisterSettings(e){register(e)}async doRegisterDefaultFlags(){return g}}})),Hooks.on("tokenActionHudCoreApiReady",(async()=>{const t=game.modules.get(e.ID);t.api={requiredCoreModuleVersion:"1.4",SystemManager:f},Hooks.call("tokenActionHudSystemReady",t)}));export{s as ACTION_TYPE,r as ACTIVATION_TYPE_ICON,n as ATTRIBUTES,o as ATTRIBUTES_ABBREVIATED,i as ATTRIBUTES_FULL_NAME,h as ActionHandler,l as CONCENTRATION_ICON,t as CORE_MODULE,g as DEFAULTS,p as GROUP,e as MODULE,d as PREPARED_ICON,u as PROFICIENCY_LEVEL_ICON,a as REQUIRED_CORE_MODULE_VERSION,c as RITUAL_ICON,y as RollHandler,f as SystemManager,m as Utils,register};
